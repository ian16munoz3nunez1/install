FROM opensuse/leap:latest
SHELL ["/bin/bash", "-c"]
ENV USER=ianemn
ENV PASSWORD=IanEMN1631

# primary configuration
RUN zypper up -y && zypper dup -y
RUN groupadd wheel
RUN ln -sfn /usr/share/zoneinfo/America/Mexico_City /etc/localtime

# Port configuration
EXPOSE 21
EXPOSE 22

# first packages
RUN zypper in -y sudo
RUN zypper in -y openssh
RUN zypper in -y vsftpd
RUN zypper in -y iputils
RUN zypper in -y iproute2
RUN zypper in -y net-tools-deprecated
RUN zypper in -y vim
RUN zypper in -y git
RUN zypper in -y tmux
RUN zypper in -y caca-utils
RUN zypper in -y curl
RUN zypper in -y wget
RUN zypper in -y tree
RUN zypper in -y ranger
RUN zypper in -y python3
RUN zypper in -y python3-Flask

RUN ssh-keygen -A

# FTP server
RUN echo "write_enable=YES" >> /etc/vsftpd.conf
RUN echo "pasv_min_port=30000" >> /etc/vsftpd.conf
RUN echo "pasv_max_port=40000" >> /etc/vsftpd.conf

# USER settings
RUN echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers
RUN useradd -rm -d /home/$USER -s /bin/bash -g root -G users,wheel $USER
RUN groupadd ianemn
RUN echo "$USER:$PASSWORD" | chpasswd

RUN mkdir /home/$USER/Desktop /home/$USER/Downloads /home/$USER/Music /home/$USER/Pictures /home/$USER/Videos
RUN chown $USER:$USER -R /home/$USER/Desktop /home/$USER/Downloads /home/$USER/Music /home/$USER/Pictures /home/$USER/Videos
RUN chmod 700 -R /home/$USER/Desktop /home/$USER/Downloads /home/$USER/Music /home/$USER/Pictures /home/$USER/Videos

# Create a git user
RUN groupadd git
RUN useradd -rm -d /home/git -s /bin/bash git
RUN echo "git:git" | chpasswd
RUN chown git:git -R /home/git
RUN chmod 700 -R /home/git
RUN touch /home/git/newRepo
RUN echo "#!/bin/bash" >> /home/git/newRepo
RUN echo "" >> /home/git/newRepo
RUN echo "if [[ \$USER == git ]];" >> /home/git/newRepo
RUN echo "then" >> /home/git/newRepo
RUN echo "    mkdir \"\$1\"" >> /home/git/newRepo
RUN echo "    chmod 700 -R \"\$1\"" >> /home/git/newRepo
RUN echo "    cd \"\$1\"" >> /home/git/newRepo
RUN echo "    git init --bare" >> /home/git/newRepo
RUN echo "    echo \"ref: refs/heads/main\" > HEAD" >> /home/git/newRepo
RUN echo "else" >> /home/git/newRepo
RUN echo "    ssh git@\$1 \"./newRepo \$2\"" >> /home/git/newRepo
RUN echo "fi" >> /home/git/newRepo
RUN chmod 700 /home/git/newRepo
RUN chown git:git /home/git/newRepo

USER $USER
WORKDIR /home/$USER

# ssh configuration
COPY --chown=git:git .ssh/id_rsa.pub /home/git/.ssh/authorized_keys
COPY --chown=$USER:$USER .ssh/id_rsa.pub /home/$USER/.ssh/authorized_keys

COPY --chown=$USER:$USER .vimrc /home/$USER/.vimrc
COPY --chown=$USER:$USER .vim/ /home/$USER/.vim/

#setup
ENTRYPOINT echo "$PASSWORD" | sudo -S /usr/sbin/sshd -D && tail -f /dev/null

