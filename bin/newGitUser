#!/bin/bash

if [[ $USER == git ]];
then
    mkdir "$1"
    if [ $? -ne 0 ]; then
        echo "Error creating user \"$1\""
        exit 1
    fi

    if [[ $2 != "" ]]; then
        echo "$2" | tee -a .ssh/authorized_keys
        if [ $? -ne 0 ]; then
            echo "Error adding ssh keys to authorized_keys"
            exit 2
        fi
    fi
else
    echo "$2" | grep -P '(\s|[^\w])' >/dev/null
    if [ $? -eq 0 ]; then
        echo "Invalid username"
        exit 1
    fi

    if [ $# -eq 2 ]; then
        ssh git@$1 "newGitUser $2"
    elif [ $# -eq 3 ]; then
        ssh git@$1 "newGitUser $2 \"$3\""
    else
        echo "More or less arguments used"
        echo "Use: $0 <host> <username> <optional ssh_key>"
    fi
fi

