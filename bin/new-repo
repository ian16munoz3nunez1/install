#!/bin/bash

if [[ $USER == git ]];
then
    if [[ $(dirname /home/git/$1) == /home/git ]]; then
        echo "Unable to write repo in path /home/git/$1" | tee -a git-audit.log
        exit 1
    fi

    if [[ "$1" =~ \.git$ ]]; then
        repo=$1
    else
        repo=$(echo $1 | sed "s/$/\.git/g")
    fi

    mkdir "$repo" &>/dev/null
    if [ $? -ne 0 ]; then
        echo "Error creating directoy \"$repo\"" | tee -a git-audit.log
        exit 2
    fi

    chmod 700 -R "$repo" &>/dev/null
    if [ $? -ne 0 ]; then
        echo "Error with permissions 700 to directoy \"$repo\"" | tee -a git-audit.log
        exit 3
    fi

    ln -rs "$repo" "$(echo $repo | sed "s/\.git$//g")" &>/dev/null
    if [ $? -ne 0 ]; then
        echo "Error linking directoy \"$repo\"" | tee -a git-audit.log
        exit 4
    fi

    cd "$repo"
    if [ $? -ne 0 ]; then
        echo "Error changing to directoy \"$repo\"" | tee -a git-audit.log
        exit 5
    fi

    git init --bare
    echo "ref: refs/heads/main" > HEAD

else
    if [ $# -lt 2 -o $# -gt 2 ]; then
        echo "More or less arguments used"
        echo "Use: $0 <host> <reponame>"
    fi

    echo "$2" | grep -P "[ !@#$%^&*()\[\]\{\}\"'<>,.?\\|]" >/dev/null
    if [ $? -eq 0 ]; then
        echo "Invalid repo name"
        exit 1
    fi

    ssh git@$1 "new-repo $2"
fi

