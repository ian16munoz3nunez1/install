#!/bin/bash

if [[ $USER == git || $USER == root ]]; then
    u2del=$1

    if [[ pwd != /home/git ]]; then
        cd /home/git
    fi

    if [[ -d $u2del ]]; then
        rm -rf $u2del/
        if [ $? -ne 0 ]; then
            echo "E001: Error deleting directory of user \"$u2del\""
            exit 1
        else
            echo "Directory of user \"$u2del\" deleted"
        fi
    fi

    if [[ -f .$u2del.dat ]]; then
        rm .$u2del.dat
        if [ $? -ne 0 ]; then
            echo "E002: Error deleting dat file of user \"$u2del\""
            exit 2
        else
            echo ".dat file for user \"$u2del\" deleted"
        fi
    fi

    ssh_key=$(grep -inP $u2del@ /home/git/.ssh/authorized_keys | cut -d: -f1)
    [ ! -z $ssh_key ] && sed -i "$ssh_key d" /home/git/.ssh/authorized_keys
    if [ $? -ne 0 ]; then
        echo "E003: Error deleting ssh key for user \"$u2del\""
        exit 3
    else
        echo "ssh key for user \"$u2del\" removed from registry"
    fi

    if [ -f git-shell-commands/$u2del ]; then
        rm git-shell-commands/$u2del
        if [ $? -ne 0 ]; then
            echo "E004: Error deleting bin file for user \"$u2del\""
            exit 4
        else
            echo "bin file for user \"$u2del\" deleted"
        fi
    fi
else
    if [ $# -eq 1 ]; then
        echo "Are you sure you want to delete the user \"ianemn\"?"
        read -n 1 -p "[Y/n]: " ans
        echo

        if [[ $ans == "" || $ans == "Y" || $ans == "y" ]]; then
            read -p "Insert your username: " username

            ssh git@$1 "delgu $username"
        fi
    else
        echo "More or less arguments used"
        echo "Use: $0 <host>"
    fi
fi
